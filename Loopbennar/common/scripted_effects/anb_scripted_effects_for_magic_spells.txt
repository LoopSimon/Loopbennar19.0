set_magic_patron = {
	set_ruler_flag = $name_key$_patron
	custom_tooltip = gain_patron_tt
	custom_tooltip = patron_$name_key$_type
	custom_tooltip = $name_key$_desc_tt
	hidden_effect = {
		[[favoured_school_1] add_ruler_modifier = { name = patron_favoured_$favoured_school_1$ duration = -1 } ]
		[[favoured_school_2] add_ruler_modifier = { name = patron_favoured_$favoured_school_2$ duration = -1 } ]
		[[disfavoured_school_1] add_ruler_modifier = { name = patron_disfavoured_$disfavoured_school_1$ duration = -1 } ]
		[[disfavoured_school_2] add_ruler_modifier = { name = patron_disfavoured_$disfavoured_school_2$ duration = -1 } ]
		[[initial_approval] set_variable = { PatronApproval = $initial_approval$ } ]
	}
}

clr_magic_patron = {
	clr_ruler_flag = $name_key$_patron
	custom_tooltip = lose_patron_tt
	hidden_effect = {
		[[favoured_school_1] remove_country_modifier = patron_favoured_$favoured_school_1$ ]
		[[favoured_school_2] remove_country_modifier = patron_favoured_$favoured_school_2$ ]
		[[disfavoured_school_1] remove_country_modifier = patron_disfavoured_$disfavoured_school_1$ ]
		[[disfavoured_school_2] remove_country_modifier = patron_disfavoured_$disfavoured_school_2$ ]
	}
}

change_patron_approval = {
	[[add]
		custom_tooltip = patron_pleased_tt
		hidden_effect = {
			change_variable = { PatronApproval = $add$ }
			if = { limit = { check_variable = { PatronApproval = 9 } }
				set_variable = { PatronApproval = 8 }
			}
		}
	]
	[[remove]
		custom_tooltip = patron_displeased_tt
		hidden_effect = {
			subtract_variable = { PatronApproval = $remove$ }
			if = { limit = { NOT = { check_variable = { PatronApproval = 0 } } }
				set_variable = { PatronApproval = 0 }
			}
		}
	]
}

### MAGIC REWORK: EVERYTHING ABOVE THIS LINE SHOULD EVENTUALLY BE REMOVED

### Spells ###

### THE HIERARCHY IS AS FOLLOWS:
### A SCHOOL DEFINES UNLOCK PATTERNS AND OTHER GROUPINGS FOR SPELLS (AKA YOU WILL UNLOCK CONJURATION 2 AFTER CONJURATION 1)
### A LEVEL IS WHAT DEFINES THE COST OF THE SPELL IN MANA: WE RESPECT FOUR LEVELS ONLY (0, 1, 2, 3) THOUGH YOU CAN MAKE MORE
### AN ID DISTINGUISHES BETWEEN DIFFERENT SPELLS OF THE SAME SCHOOL AND LEVEL
### EXAMPLE (abjuration_2_0_effect) and (abjuration_2_1_effect). BOTH ABJURATION, BOTH LEVEL 2, DIFFERENT ID'S

make_spell_free = {
	[[ruler]
		custom_tooltip = $school$_$level$_$id$_spell_free
		custom_tooltip = while_ruler_alive_tt
		set_ruler_flag = $school$_$level$_$id$_spell_free
	]
	[[heir]
		custom_tooltip = $school$_$level$_$id$_spell_free
		custom_tooltip = while_heir_alive_tt
		set_heir_flag = $school$_$level$_$id$_spell_free
	]
	[[next_cast]
		custom_tooltip = $school$_$level$_$id$_spell_free
		custom_tooltip = for_next_cast_only_tt
		set_country_flag = $school$_$level$_$id$_spell_free_next_cast
	]
	[[duration]
		add_country_modifier = { name = $school$_$level$_$id$_spell_free duration = $duration$ }
	]
}
make_spell_school_free = {
	[[ruler]
		custom_tooltip = $school$_spell_free
		custom_tooltip = while_ruler_alive_tt
		set_ruler_flag = $school$_spell_free
	]
	[[heir]
		custom_tooltip = $school$_spell_free
		custom_tooltip = while_heir_alive_tt
		set_heir_flag = $school$_spell_free
	]
	[[next_cast]
		custom_tooltip = $school$_spell_free
		custom_tooltip = for_next_cast_only_tt
		set_country_flag = $school$_spell_free_next_cast
	]
	[[duration]
		add_country_modifier = { name = $school$_spell_free duration = $duration$ }
	]
}
make_spell_half_off = {
	[[ruler]
		custom_tooltip = $school$_$level$_$id$_spell_half
		custom_tooltip = while_ruler_alive_tt
		set_ruler_flag = $school$_$level$_$id$_spell_half
	]
	[[heir]
		custom_tooltip = $school$_$level$_$id$_spell_half
		custom_tooltip = while_heir_alive_tt
		set_heir_flag = $school$_$level$_$id$_spell_half
	]
	[[next_cast]
		custom_tooltip = $school$_$level$_$id$_spell_half
		custom_tooltip = for_next_cast_only_tt
		set_country_flag = $school$_$level$_$id$_spell_half_next_cast
	]
	[[duration]
		add_country_modifier = { name = $school$_$level$_$id$_spell_half duration = $duration$ }
	]
}
make_spell_school_half_off = {
	[[ruler]
		custom_tooltip = $school$_spell_half
		custom_tooltip = while_ruler_alive_tt
		set_ruler_flag = $school$_spell_half
	]
	[[heir]
		custom_tooltip = $school$_spell_half
		custom_tooltip = while_heir_alive_tt
		set_heir_flag = $school$_spell_half
	]
	[[next_cast]
		custom_tooltip = $school$_spell_half
		custom_tooltip = for_next_cast_only_tt
		set_country_flag = $school$_spell_half_next_cast
	]
	[[duration]
		add_country_modifier = { name = $school$_spell_half duration = $duration$ }
	]
}
generic_cast_spell = {

	# Handles paying mana, given a limited number of ways to alter mana cost
	if = {
		limit = { #Free spell!
			OR = {
				has_country_modifier = all_spell_free
				has_country_flag = all_spell_free_next_cast
				has_ruler_flag = all_spell_free

				has_country_modifier = $school$_$level$_$id$_spell_free
				has_country_flag = $school$_$level$_$id$_spell_free_next_cast
				has_ruler_flag = $school$_$level$_$id$_spell_free

				has_country_modifier = $school$_spell_free
				has_country_flag = $school$_spell_free_next_cast
				has_ruler_flag = $school$_spell_free
			}
		}
		custom_tooltip = spell_is_free_tt

		trigger_switch = { #Next cast free spell handled inside
			on_trigger = has_country_flag

			$school$_$level$_$id$_spell_free_next_cast = { custom_tooltip = for_next_cast_only_tt clr_country_flag = $school$_$level$_$id$_spell_free_next_cast }
			$school$_spell_free_next_cast = { custom_tooltip = for_next_cast_only_tt clr_country_flag = $school$_spell_free_next_cast }
			all_spell_free_next_cast = { custom_tooltip = for_next_cast_only_tt clr_country_flag = all_spell_half_next_cast }
		}
	}
	else_if = { #Half-cost spell
		limit = {
			OR = {
				has_country_modifier = all_spell_half
				has_country_flag = all_spell_half_next_cast
				has_ruler_flag = all_spell_half

				has_country_modifier = $school$_$level$_$id$_spell_half
				has_country_flag = $school$_$level$_$id$_spell_half_next_cast
				has_ruler_flag = $school$_$level$_$id$_spell_half

				has_country_modifier = $school$_spell_half
				has_country_flag = $school$_spell_half_next_cast
				has_ruler_flag = $school$_spell_half
			}
		}
		custom_tooltip = spell_is_half_tt

		trigger_switch = { #Next cast half-cost spell handled inside
			on_trigger = has_country_flag

			$school$_$level$_$id$_spell_half_next_cast = { custom_tooltip = for_next_cast_only_tt clr_country_flag = $school$_$level$_$id$_spell_half_next_cast }
			$school$_spell_half_next_cast = { custom_tooltip = for_next_cast_only_tt clr_country_flag = $school$_spell_half_next_cast }
			all_spell_half_next_cast = { custom_tooltip = for_next_cast_only_tt clr_country_flag = all_spell_half_next_cast }
		}

		pay_half_mana_for_level_$level$_spell = yes
	}
	else = { pay_mana_for_level_$level$_spell = yes }

	[[war]
		if = { #Infinite war magic witch-king
			limit = { NOT = { has_country_modifier = witch_king_annihilate_modifier } }
			custom_tooltip = only_one_war_magic_tt
			hidden_effect = { clear_active_war_magic = yes }
		}
	]

	$school$_$level$_$id$_effect = yes
}
pay_half_mana_for_level_0_spell = { change_mana = { amount = -12.5 } }
pay_mana_for_level_0_spell = { change_mana = { amount = -25 } }
pay_half_mana_for_level_1_spell = { change_mana = { amount = -25 } }
pay_mana_for_level_1_spell = { change_mana = { amount = -50 } }
pay_half_mana_for_level_2_spell = { change_mana = { amount = -50 } }
pay_mana_for_level_2_spell = { change_mana = { amount = -100 } }
pay_half_mana_for_level_3_spell = { change_mana = { amount = -100 } }
pay_mana_for_level_3_spell = { change_mana = { amount = -200 } }

clear_active_war_magic = {
	trigger_switch = {
		on_trigger = has_country_modifier
		abjuration_0_0_mod = { remove_country_modifier = abjuration_0_0_mod }
		abjuration_2_1_mod = { remove_country_modifier = abjuration_2_1_mod }
		divination_2_1_mod = { remove_country_modifier = divination_2_1_mod }
		divination_2_1_mod_buffed = { remove_country_modifier = divination_2_1_mod_buffed }
		enchantment_1_0_mod = { remove_country_modifier = enchantment_1_0_mod }
		enchantment_2_0_mod = { remove_country_modifier = enchantment_2_0_mod }
		evocation_1_0_mod = { remove_country_modifier = evocation_1_0_mod }
		evocation_1_1_mod = { remove_country_modifier = evocation_1_1_mod }
		evocation_3_0_mod = { remove_country_modifier = evocation_3_0_mod }

		#Patrons
		patron_green_shock_and_awe = { remove_country_modifier = patron_green_shock_and_awe }
		patron_green_munitions = { remove_country_modifier = patron_green_munitions }
		patron_green_elemental_fury = { remove_country_modifier = patron_green_elemental_fury }
		patron_ice_shock_and_awe = { remove_country_modifier = patron_ice_shock_and_awe }
		patron_ice_munitions = { remove_country_modifier = patron_ice_munitions }
		patron_ice_elemental_fury = { remove_country_modifier = patron_ice_elemental_fury }
		patron_diranbe_shock_and_awe = { remove_country_modifier = patron_diranbe_shock_and_awe }
		patron_diranbe_munitions = { remove_country_modifier = patron_diranbe_munitions }
		patron_diranbe_elemental_fury = { remove_country_modifier = patron_diranbe_elemental_fury }

		#Verkal Ozovar
		Y63_minor_rune_argzana = { remove_country_modifier = Y63_minor_rune_argzana }
		Y63_minor_rune_jolkin_kanzad = { remove_country_modifier = Y63_minor_rune_jolkin_kanzad }

		#Azjakuma
		estate_shinukhorchi_korashi_talisman_mod = { remove_country_modifier = estate_shinukhorchi_korashi_talisman_mod }
	}
}

remove_harmful_siege_magic = { #Remove siege magic that's bad after you siege down a province
	remove_province_modifier = enchantment_3_0_siege_mod
	remove_province_modifier = transmutation_1_1_local_mod
	remove_province_modifier = necromancy_1_1_local_mod
}

ai_magic_siege_pulse = {
	if = {
		limit = {
			is_at_war = yes #Most restrictive triggers first
			has_war_wizard = yes

			ai = yes #This is an AI handler
			can_use_magic = yes
			check_variable = { currentMana = -25 } #let AI go into mana debt

			any_army = { #Evaluates per-army, not per-regiment
				location = {
					fort_level = 1
					siege_interface_siege_trigger = yes
				}
			}
		}
		country_event = { id = magic_system.304 } #Siege magic handler
	}
}

##################
### ABJURATION ###
##################

abjuration_0_0_effect = { # Combat Ward
	add_country_modifier = { name = abjuration_0_0_mod duration = 180 }
}
abjuration_1_0_effect = { # Ward
	PREV = {
		custom_tooltip = change_siege_negative_tt
		hidden_effect = { change_siege = -1 }
		abjuration_1_0_sub_effect = { duration = 3650 }
	}
}
abjuration_1_0_sub_effect = { # Ward sub-effect
	if = { #Patron buffs
		limit = { PREV = { OR = { has_ruler_flag = yaksha_patron has_ruler_flag = maiden_patron } } }
		custom_tooltip = magic_booster_by_patron_tt
		add_province_modifier = { name = patron_abjuration_ward duration = $duration$ }
	}

	if = {
		limit = { owner = { at_least_magic_project_level = { project = magical_fortress level = 3 } } }
		add_province_modifier = { name = abjuration_1_0_mod_3 duration = $duration$ }
		custom_tooltip = abjuration_1_0_upgrade_3
		hidden_effect = {
			province_event = { id = kheionai.2 } #wind wards from fort
			province_event = { id = kheionai.2 days = $duration$ }
		}
	}
	else_if = {
		limit = { owner = { at_least_magic_project_level = { project = magical_fortress level = 2 } } }
		add_province_modifier = { name = abjuration_1_0_mod_2 duration = $duration$ }
		custom_tooltip = abjuration_1_0_upgrade_2
		hidden_effect = {
			province_event = { id = kheionai.2 } #wind wards from fort
			province_event = { id = kheionai.2 days = $duration$ }
		}
	}
	else_if = {
		limit = { owner = { at_least_magic_project_level = { project = magical_fortress level = 1 } } }
		add_province_modifier = { name = abjuration_1_0_mod_1 duration = $duration$ }
		custom_tooltip = abjuration_1_0_upgrade_1
	}
	else = {
		add_province_modifier = { name = abjuration_1_0_mod_0 duration = $duration$ }
		custom_tooltip = abjuration_1_0_upgrade_0
	}
}
abjuration_1_1_effect = { # Protected Journey
	add_country_modifier = { name = abjuration_1_1_mod duration = 3650 }
}
abjuration_2_0_effect = { # Mass Ward
	custom_tooltip = abjuration_2_0_spell_effect_tt
	hidden_effect = {
		add_country_modifier = { name = abjuration_2_0_cooldown_mod duration = 1825 hidden = yes }
		every_owned_province = {
			limit = { fort_level = 1 controlled_by = PREV }
			abjuration_1_0_sub_effect = { duration = 1825 }
		}
	}
}
abjuration_2_1_effect = { # Mage Armour
	add_country_modifier = { name = abjuration_2_1_mod duration = 1825 }
}
abjuration_3_0_effect = { # Field of Forbiddance
	if = {
		limit = {
			6729 = { #Have Azmera's Wezinmesig
				owned_by = ROOT
				has_great_project = { 
					type = azmeras_wezinmesig
					tier = 3
				}
				can_use_azmeras_wezinmesig = yes
			}
		}
		abjuration_3_0_sub_effect = { duration = 7300 }
	}
	else = { abjuration_3_0_sub_effect = { duration = 3650 } }
}
abjuration_3_0_sub_effect = {
	decrease_estate_witch_king_points = { size = large }
	custom_tooltip = every_mage_tower_tt
	tooltip = { 4160 = { add_province_modifier = { name = abjuration_3_0_local_mod duration = $duration$ } } }
	hidden_effect = {
		add_country_modifier = { name = abjuration_3_0_cooldown_mod duration = $duration$ hidden = yes }
		every_owned_province = {
			limit = { has_building = mage_tower }
			add_province_modifier = { name = abjuration_3_0_local_mod duration = $duration$ }
		}
	}
}

###################
### CONJURATION ###
###################

conjuration_0_0_effect = { # Summon Familiars
	add_country_modifier = { name = conjuration_0_0_mod duration = 1825 }

	if = {
		limit = {
			type_is_advancing_school = { type = country school = abjuration }
			is_ruler_abjuration_level_3 = yes
		}
		custom_tooltip = conjuration_0_0_spell_effect_yes_tt
		add_country_modifier = { name = conjuration_0_0_mod_abjuration duration = 1825 }
	}
	else_if = {
		limit = {
			type_is_advancing_school = { type = country school = conjuration }
			is_ruler_conjuration_level_3 = yes
		}
		custom_tooltip = conjuration_0_0_spell_effect_yes_tt
		add_country_modifier = { name = conjuration_0_0_mod_conjuration duration = 1825 }
	}
	else_if = {
		limit = {
			type_is_advancing_school = { type = country school = divination }
			is_ruler_divination_level_3 = yes
		}
		custom_tooltip = conjuration_0_0_spell_effect_yes_tt
		add_country_modifier = { name = conjuration_0_0_mod_divination duration = 1825 }
	}
	else_if = {
		limit = {
			type_is_advancing_school = { type = country school = enchantment }
			is_ruler_enchantment_level_3 = yes
		}
		custom_tooltip = conjuration_0_0_spell_effect_yes_tt
		add_country_modifier = { name = conjuration_0_0_mod_enchantment duration = 1825 }
	}
	else_if = {
		limit = {
			type_is_advancing_school = { type = country school = evocation }
			is_ruler_evocation_level_3 = yes
		}
		custom_tooltip = conjuration_0_0_spell_effect_yes_tt
		add_country_modifier = { name = conjuration_0_0_mod_evocation duration = 1825 }
	}
	else_if = {
		limit = {
			type_is_advancing_school = { type = country school = illusion }
			is_ruler_illusion_level_3 = yes
		}
		custom_tooltip = conjuration_0_0_spell_effect_yes_tt
		add_country_modifier = { name = conjuration_0_0_mod_illusion duration = 1825 }
	}
	else_if = {
		limit = {
			type_is_advancing_school = { type = country school = necromancy }
			is_ruler_necromancy_level_3 = yes
		}
		custom_tooltip = conjuration_0_0_spell_effect_yes_tt
		add_country_modifier = { name = conjuration_0_0_mod_necromancy duration = 1825 }
	}
	else_if = {
		limit = {
			type_is_advancing_school = { type = country school = transmutation }
			is_ruler_transmutation_level_3 = yes
		}
		custom_tooltip = conjuration_0_0_spell_effect_yes_tt
		add_country_modifier = { name = conjuration_0_0_mod_transmutation duration = 1825 }
	}
	else = { custom_tooltip = conjuration_0_0_spell_effect_no_tt }

}
conjuration_1_0_effect = { # Summon Animals
	custom_tooltip = conjuration_1_0_spell_effect_tt
	add_country_modifier = { name = conjuration_1_0_mod duration = 1825 }
	hidden_effect = {
		country_event = { id = magic_spell.202 days = 1825 }
	}
}
conjuration_1_1_effect = { # Conjure Supplies
	add_country_modifier = { name = conjuration_1_1_mod duration = 3650 }
}
conjuration_2_0_effect = { # Summon Elementals
	custom_tooltip = conjuration_2_0_spell_effect_tt
	add_country_modifier = { name = conjuration_2_0_mod duration = 3650 }
	hidden_effect = {
		country_event = { id = magic_spell.203 days = 3650 }
	}
}
conjuration_2_1_effect = { # Aid Construction
	add_country_modifier = { name = conjuration_2_1_mod duration = 1825 }
}
conjuration_3_0_effect = { # Extraplanar Contact
	increase_estate_witch_king_points = { size = large }
	add_country_modifier = { name = conjuration_3_0_estate_mod duration = 3650 }

	if = {
		limit = { has_country_flag = witch_king_skill }
		if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 0 } }
			make_spell_half_off = { school = divination level = 3 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 1 } }
			make_spell_half_off = { school = enchantment level = 3 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 2 } }
			make_spell_half_off = { school = illusion level = 3 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 3 } }
			make_spell_half_off = { school = necromancy level = 3 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 4 } }
			make_spell_half_off = { school = transmutation level = 3 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = -4 } }
		}
	}
	
	if = {
		limit = { ruler_is_powerful_mage = yes }
		tooltip = { give_ruler_random_spell_school = yes } #instant feedback on what improved
		increase_ruler_witch_king_points = { size = large }

		hidden_effect = {
			set_variable = { which = max_var value = 0 }
			if = { limit = { NOT = { is_ruler_abjuration_level_3 = yes } }
				change_variable = { max_var = 1 }
			}
			if = { limit = { NOT = { is_ruler_conjuration_level_3 = yes } }
				change_variable = { max_var = 1 }
			}
			if = { limit = { NOT = { is_ruler_divination_level_3 = yes } }
				change_variable = { max_var = 1 }
			}
			if = { limit = { NOT = { is_ruler_enchantment_level_3 = yes } }
				change_variable = { max_var = 1 }
			}
			if = { limit = { NOT = { is_ruler_evocation_level_3 = yes } }
				change_variable = { max_var = 1 }
			}
			if = { limit = { NOT = { is_ruler_illusion_level_3 = yes } }
				change_variable = { max_var = 1 }
			}
			if = { limit = { NOT = { is_ruler_necromancy_level_3 = yes } }
				change_variable = { max_var = 1 }
			}
			if = { limit = { NOT = { is_ruler_transmutation_level_3 = yes } }
				change_variable = { max_var = 1 }
			}

			randnum_effect = { max_var = max_var }
			if = { limit = { NOT = { is_ruler_abjuration_level_3 = yes } }
				subtract_variable = { which = randnum value = 1 }
				if = { limit = { is_variable_equal = { which = randnum value = 0 } }
					magic_school_level_up = { type = ruler school = abjuration }
				}
			}
			if = { limit = { NOT = { is_ruler_conjuration_level_3 = yes } }
				subtract_variable = { which = randnum value = 1 }
				if = { limit = { is_variable_equal = { which = randnum value = 0 } }
					magic_school_level_up = { type = ruler school = conjuration }
				}
			}
			if = { limit = { NOT = { is_ruler_divination_level_3 = yes } }
				subtract_variable = { which = randnum value = 1 }
				if = { limit = { is_variable_equal = { which = randnum value = 0 } }
					magic_school_level_up = { type = ruler school = divination }
				}
			}
			if = { limit = { NOT = { is_ruler_enchantment_level_3 = yes } }
				subtract_variable = { which = randnum value = 1 }
				if = { limit = { is_variable_equal = { which = randnum value = 0 } }
					magic_school_level_up = { type = ruler school = enchantment }
				}
			}
			if = { limit = { NOT = { is_ruler_evocation_level_3 = yes } }
				subtract_variable = { which = randnum value = 1 }
				if = { limit = { is_variable_equal = { which = randnum value = 0 } }
					magic_school_level_up = { type = ruler school = evocation }
				}
			}
			if = { limit = { NOT = { is_ruler_illusion_level_3 = yes } }
				subtract_variable = { which = randnum value = 1 }
				if = { limit = { is_variable_equal = { which = randnum value = 0 } }
					magic_school_level_up = { type = ruler school = illusion }
				}
			}
			if = { limit = { NOT = { is_ruler_necromancy_level_3 = yes } }
				subtract_variable = { which = randnum value = 1 }
				if = { limit = { is_variable_equal = { which = randnum value = 0 } }
					magic_school_level_up = { type = ruler school = necromancy }
				}
			}
			if = { limit = { NOT = { is_ruler_transmutation_level_3 = yes } }
				subtract_variable = { which = randnum value = 1 }
				if = { limit = { is_variable_equal = { which = randnum value = 0 } }
					magic_school_level_up = { type = ruler school = transmutation }
				}
			}
		}
	}
	else = {
		custom_tooltip = conjuration_3_0_spell_effect_no_tt
		tooltip = { increase_ruler_witch_king_points = { size = large } }
	}
}

##################
### DIVINATION ###
##################

divination_0_0_effect = {  # Guidance
	if = {
		limit = { has_country_flag = witch_king_thorns }
		if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 0 } }
			make_spell_half_off = { school = abjuration level = 0 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 1 } }
			make_spell_half_off = { school = conjuration level = 0 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 2 } }
			make_spell_half_off = { school = evocation level = 0 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 3 } }
			make_spell_half_off = { school = illusion level = 0 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 4 } }
			make_spell_half_off = { school = necromancy level = 0 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = 1 } }
		}
		else_if = {
			limit = { is_variable_equal = { which = witch_king_tracker_var value = 5 } }
			make_spell_half_off = { school = transmutation level = 0 id = 0 next_cast = yes }
			hidden_effect = { change_variable = { witch_king_tracker_var = -5 } }
		}
	}

	if = {
		limit = { at_least_magic_project_level = { project = orb_of_omniscience level = 1 } }
		tooltip = {
			random_list = {
				1 = { add_adm_power = 25 }
				1 = { add_dip_power = 25 }
				1 = { add_mil_power = 25 }
			}
		}
		custom_tooltip = divination_0_0_upgrade_yes
		hidden_effect = {
			randnum_effect = {
				max = 3
				case3 = " add_mil_power = 25 "
				case2 = " add_dip_power = 25 "
				case1 = " add_adm_power = 25 "
			}
		}
	}
	else = {
		tooltip = {
			random_list = {
				1 = { add_adm_power = 20 }
				1 = { add_dip_power = 20 }
				1 = { add_mil_power = 20 }
			}
		}
		custom_tooltip = divination_0_0_upgrade_no
		hidden_effect = {
			randnum_effect = {
				max = 3
				case3 = " add_mil_power = 20 "
				case2 = " add_dip_power = 20 "
				case1 = " add_adm_power = 20 "
			}
		}
	}
	
	hidden_effect = {
		if = {
			limit = { has_country_modifier = orb_of_omniscience_div_tracker }
			change_variable = { orb_of_omniscience_progress_tracker = 25 }
		}
	}
}
divination_1_0_effect = {  # Eye for Talent
	custom_tooltip = divination_1_0_spell_effect_tt
	country_event = { id = magic_spell.300 }
	if = {
		limit = { exactly_magic_project_level = { project = orb_of_omniscience level = 0 } }
		custom_tooltip = divination_1_0_upgrade_no
	}
	else = { custom_tooltip = divination_1_0_upgrade_yes }
	
	hidden_effect = {
		if = {
			limit = { has_country_modifier = orb_of_omniscience_div_tracker }
			change_variable = { orb_of_omniscience_progress_tracker = 50 }
		}
	}
}
divination_1_0_hire_sub_effect = { # Eye for Talent sub-effect
	if = {
		limit = { exactly_magical_infrastructure_level = { level = 4 } }
		define_advisor = {
			type = $type$
			skill = 5
			discount = yes
		}
	}
	else_if = {
		limit = { exactly_magical_infrastructure_level = { level = 3 } }
		define_advisor = {
			type = $type$
			skill = 4
			discount = yes
		}
	}
	else_if = {
		limit = { exactly_magical_infrastructure_level = { level = 2 } }
		define_advisor = {
			type = $type$
			skill = 3
			discount = yes
		}
	}
	else_if = {
		limit = { exactly_magical_infrastructure_level = { level = 1 } }
		define_advisor = {
			type = $type$
			skill = 2
			discount = yes
		}
	}
	else = { #exactly_magical_infrastructure_level = { level = 0 }
		define_advisor = {
			type = $type$
			skill = 1
			discount = yes
		}
	}
}
divination_1_0_hire_effect = { # Eye for Talent sub-effect 2
	if = {
		limit = { has_country_flag = adm_advisors }
		divination_1_0_hire_sub_effect = { type = $adm$ }
	}
	else_if = {
		limit = { has_country_flag = dip_advisors }
		divination_1_0_hire_sub_effect = { type = $dip$ }
	}
	else = { divination_1_0_hire_sub_effect = { type = $mil$ } }
}
divination_1_1_effect = {  # Deposit Divination
	custom_tooltip = divination_1_1_spell_effect
	if = {
		limit = { at_least_magic_project_level = { project = orb_of_omniscience level = 2 } }
		if = {
			limit = { receiving_mindarayan_buff = yes }
			if = {
				limit = { 4527 = { has_great_project = { type = oracle_mountain tier = 3 } } }
				divination_1_1_sub_effect = { days = 5110 }
			}
			else = { divination_1_1_sub_effect = { days = 4380 } }
			custom_tooltip = tughayasa_divination_booster_tt
		}
		else = { divination_1_1_sub_effect = { days = 3650 } }
		custom_tooltip = divination_1_1_upgrade_yes
	}
	else = {
		if = {
			limit = { receiving_mindarayan_buff = yes }
			if = {
				limit = { 4527 = { has_great_project = { type = oracle_mountain tier = 3 } } }
				divination_1_1_sub_effect = { days = 2555 }
			}
			else = { divination_1_1_sub_effect = { days = 2190 } }
			custom_tooltip = tughayasa_divination_booster_tt
		}
		else = { divination_1_1_sub_effect = { days = 1825 } }
		custom_tooltip = divination_1_1_upgrade_no
	}

	hidden_effect = {
		if = {
			limit = { has_country_modifier = orb_of_omniscience_div_tracker }
			change_variable = { orb_of_omniscience_progress_tracker = 50 }
		}
	}
}
divination_1_1_sub_effect = { #Deposit Divination sub-effect
	tooltip = { 4160 = { add_province_modifier = { name = divination_1_1_local_mod duration = $days$ } } }
	hidden_effect = {
		every_owned_province = {
			limit = { province_with_mineable_goods = yes }
			add_province_modifier = { name = divination_1_1_local_mod duration = $days$ }
		}
		add_country_modifier = { name = divination_1_1_cooldown_mod duration = $days$ hidden = yes }
	}
}
divination_2_0_effect = {  # Scry #VERY FINICKY ABOUT ROOT SCOPE DUE TO FOW EFFECT
	if = {
		limit = { at_least_magic_project_level = { project = orb_of_omniscience level = 2 } }
		if = {
			limit = {
				has_ruler_flag = ancestor_spirit_patron
				receiving_mindarayan_buff = yes
			}
			if = { #80%
				limit = { 4527 = { has_great_project = { type = oracle_mountain tier = 3 } } }
				divination_2_0_sub_effect = { days = 6570 months = 216 buffed = yes }
			}
			else = { divination_2_0_sub_effect = { days = 5840 months = 192 buffed = yes } }
			custom_tooltip = magic_booster_by_patron_tt
			custom_tooltip = tughayasa_divination_booster_tt
		}
		else_if = {
			limit = { has_ruler_flag = ancestor_spirit_patron }
			divination_2_0_sub_effect = { days = 5110 months = 168 buffed = yes }
			custom_tooltip = magic_booster_by_patron_tt
		}
		else_if = { #getting a mindarayan buff
			limit = { receiving_mindarayan_buff = yes }
			if = { #40%
				limit = { 4527 = { has_great_project = { type = oracle_mountain tier = 3 } } }
				divination_2_0_sub_effect = { days = 5110 months = 168 buffed = yes }
			}
			else = { divination_2_0_sub_effect = { days = 4380 months = 144 buffed = yes } }
			custom_tooltip = tughayasa_divination_booster_tt
		}
		else = { divination_2_0_sub_effect = { days = 3650 months = 120 buffed = yes } }
		custom_tooltip = divination_2_0_upgrade_yes
	}
	else = {
		if = {
			limit = {
				has_ruler_flag = ancestor_spirit_patron
				receiving_mindarayan_buff = yes
			}
			if = { #80%
				limit = { 4527 = { has_great_project = { type = oracle_mountain tier = 3 } } }
				divination_2_0_sub_effect = { days = 3285 months = 108 }
			}
			else = { divination_2_0_sub_effect = { days = 2920 months = 96 } }
			custom_tooltip = magic_booster_by_patron_tt
			custom_tooltip = tughayasa_divination_booster_tt
		}
		else_if = {
			limit = { has_ruler_flag = ancestor_spirit_patron }
			divination_2_0_sub_effect = { days = 2555 months = 84 }
			custom_tooltip = magic_booster_by_patron_tt
		}
		else_if = { #getting a mindarayan buff
			limit = { receiving_mindarayan_buff = yes }
			if = { #40%
				limit = { 4527 = { has_great_project = { type = oracle_mountain tier = 3 } } }
				divination_2_0_sub_effect = { days = 2555 months = 84 }
			}
			else = { divination_2_0_sub_effect = { days = 2190 months = 72 } }
			custom_tooltip = tughayasa_divination_booster_tt
		}
		else = { divination_2_0_sub_effect = { days = 1825 months = 60 } }
		custom_tooltip = divination_2_0_upgrade_no
	}

	hidden_effect = {
		if = {
			limit = { has_country_modifier = orb_of_omniscience_div_tracker }
			change_variable = { orb_of_omniscience_progress_tracker = 100 }
		}
	}
}
divination_2_0_sub_effect = { #Scry sub-effect
	custom_tooltip = spell_sabotage_effect_tt
	tooltip = {
		remove_fow = $months$
		[[buffed] add_spy_network_from = { who = THIS value = 25 } ]
	}
	hidden_effect = {
		add_or_extend_country_modifier = { name = is_scrying_mod duration = $days$ hidden = yes }
		every_war_enemy_country = {
			remove_fow = $months$
			every_owned_province = { discover_country = ROOT }
			[[buffed] add_spy_network_from = { who = ROOT value = 25 } ]
		}
		every_rival_country = {
			remove_fow = $months$
			every_owned_province = { discover_country = ROOT }
			[[buffed] add_spy_network_from = { who = ROOT value = 25 } ]
		}
	}
	if = {
		limit = {
			OR = {
				any_war_enemy_country = { institution_difference = { who = ROOT value = 1 } }
				any_rival_country = { institution_difference = { who = ROOT value = 1 } }
			}
		}
		capital_scope = { add_province_modifier = { name = divination_2_0_local_mod duration = $days$ } }
	}
	else = { custom_tooltip = divination_2_0_spell_effect_tt }
}
divination_2_1_effect = {  # Manipulated Fortune
	if = {
		limit = { receiving_mindarayan_buff = yes }
		if = {
			limit = { 4527 = { has_great_project = { type = oracle_mountain tier = 3 } } }
			divination_2_1_sub_effect = { days = 2555 }
		}
		else = { divination_2_1_sub_effect = { days = 2190 } }
		custom_tooltip = tughayasa_divination_booster_tt
	}
	else = { divination_2_1_sub_effect = { days = 1825 } }

	hidden_effect = {
		if = {
			limit = { has_country_modifier = orb_of_omniscience_div_tracker }
			change_variable = { orb_of_omniscience_progress_tracker = 100 }
		}
	}
}
divination_2_1_sub_effect = { #Manipulated Fortune sub-effect
	if = {
		limit = { at_least_magic_project_level = { project = orb_of_omniscience level = 3 } }
		add_country_modifier = { name = divination_2_1_mod_buffed duration = $days$ }
		custom_tooltip = divination_2_1_upgrade_yes
	}
	else = {
		add_country_modifier = { name = divination_2_1_mod duration = $days$ }
		custom_tooltip = divination_2_1_upgrade_no
	}
}
divination_3_0_effect = {  # Foresight
	if = {
		limit = { receiving_mindarayan_buff = yes }
		if = {
			limit = { 4527 = { has_great_project = { type = oracle_mountain tier = 3 } } }
			divination_3_0_sub_effect = { days = 511 }
		}
		else = { divination_3_0_sub_effect = { days = 438 } }
		custom_tooltip = tughayasa_divination_booster_tt
	}
	else = { divination_3_0_sub_effect = { days = 365 } }

	if = {
		limit = {
			OR = {
				capital_scope = { superregion = rahen_superregion }
				capital_scope = { superregion = vimdatrong_superregion }
				capital_scope = { superregion = yanshen_superregion }
			}
			NOT = {
				has_country_flag = tughayasa_quest_foresight_casted
			}
		}
		set_country_flag = tughayasa_quest_foresight_casted
	}

	hidden_effect = {
		if = {
			limit = { has_country_modifier = orb_of_omniscience_div_tracker }
			change_variable = { orb_of_omniscience_progress_tracker = 200 }
		}
	}
}
divination_3_0_sub_effect = { #Foresight sub-effect
	if = {
		limit = { at_least_magic_project_level = { project = orb_of_omniscience level = 3 } }
		add_country_modifier = { name = divination_3_0_mod_buffed duration = $days$ }
		custom_tooltip = divination_3_0_upgrade_yes
	}
	else = {
		add_country_modifier = { name = divination_3_0_mod duration = $days$ }
		custom_tooltip = divination_3_0_upgrade_no
	}
}

###################
### ENCHANTMENT ###
###################

enchantment_0_0_effect = { # Enchanting Embassy
	decrease_ruler_witch_king_points = { size = small }
	if = {
		limit = { has_country_flag = Y63_enchantment_upgrade }
		add_country_modifier = { name = enchantment_0_0_mod duration = 2555 }
		custom_tooltip = Y63_enchantment_booster_tt
	}
	else = { add_country_modifier = { name = enchantment_0_0_mod duration = 1825 } }

	if = {
		limit = { has_country_modifier = U10_extravagant_surplus }
		add_country_modifier = { name = U10_khet_feast duration = 1825 }
	}
}
enchantment_1_0_effect = { # Mass Charm
	if = {
		limit = {
			OR = {
				has_ruler_flag = huli_jing_patron
				has_ruler_flag = gumiho_patron
				has_ruler_flag = summer_waves_patron
			}
			has_country_flag = Y63_enchantment_upgrade
		}
		add_country_modifier = { name = enchantment_1_0_mod duration = 3285 }
		custom_tooltip = Y63_enchantment_booster_tt
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = { has_country_flag = Y63_enchantment_upgrade }
		add_country_modifier = { name = enchantment_1_0_mod duration = 2555 }
		custom_tooltip = Y63_enchantment_booster_tt
	}
	else_if = {
		limit = {
			OR = {
				has_ruler_flag = huli_jing_patron
				has_ruler_flag = gumiho_patron
				has_ruler_flag = summer_waves_patron
			}
		}
		add_country_modifier = { name = enchantment_1_0_mod duration = 2555 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else = { add_country_modifier = { name = enchantment_1_0_mod duration = 1825 } }
	hidden_effect = { country_event = { id = magic_spell.400 days = 1825 random = 3650 } }
}
enchantment_1_1_effect = { # Command Animals
	if = {
		limit = { has_country_flag = Y63_enchantment_upgrade }
		enchantment_1_1_sub_effect = { days = 2555 }
		custom_tooltip = Y63_enchantment_booster_tt
	}
	else = { enchantment_1_1_sub_effect = { days = 1825 } }

	if = {
		limit = { has_country_flag = witch_king_rise }
		custom_tooltip = witch_king_rise_effect
		hidden_effect = {
			every_owned_province = {
				limit = { province_with_animal_goods = yes }
				add_devastation = -10
				add_prosperity = 20
			}
		}
	}
}
enchantment_1_1_sub_effect = { # Command Animals sub-effect
	add_country_modifier = { name = enchantment_1_1_mod duration = $days$ }
	custom_tooltip = enchantment_1_1_spell_effect_tt
	tooltip = {
		4160 = { add_province_modifier = { name = enchantment_1_1_local_mod duration = $days$ } }
	}
	hidden_effect = {
		every_owned_province = {
			limit = { province_with_animal_goods = yes }
			add_province_modifier = { name = enchantment_1_1_local_mod duration = $days$ }
		}
	}
}
enchantment_2_0_effect = { # Mass Charm 2
	if = {
		limit = {
			OR = {
				has_ruler_flag = huli_jing_patron
				has_ruler_flag = gumiho_patron
				has_ruler_flag = summer_waves_patron
			}
			has_country_flag = Y63_enchantment_upgrade
		}
		add_country_modifier = { name = enchantment_2_0_mod duration = 3285 }
		custom_tooltip = Y63_enchantment_booster_tt
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = { has_country_flag = Y63_enchantment_upgrade }
		add_country_modifier = { name = enchantment_2_0_mod duration = 2555 }
		custom_tooltip = Y63_enchantment_booster_tt
	}
	else_if = {
		limit = {
			OR = {
				has_ruler_flag = huli_jing_patron
				has_ruler_flag = gumiho_patron
				has_ruler_flag = summer_waves_patron
			}
		}
		add_country_modifier = { name = enchantment_2_0_mod duration = 2555 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else = { add_country_modifier = { name = enchantment_2_0_mod duration = 1825 } }
	hidden_effect = { country_event = { id = magic_spell.400 days = 1825 random = 3650 } }
}
enchantment_2_1_effect = { # Enchanting Embassy 2
	decrease_ruler_witch_king_points = { size = large }
	remove_country_modifier = enchantment_0_0_mod
	if = {
		limit = { has_country_flag = Y63_enchantment_upgrade }
		add_country_modifier = { name = enchantment_2_1_mod duration = 5110 }
		custom_tooltip = Y63_enchantment_booster_tt
	}
	else = { add_country_modifier = { name = enchantment_2_1_mod duration = 3650 } }

	if = {
		limit = { has_country_modifier = U10_extravagant_surplus }
		add_country_modifier = { name = U10_khet_feast duration = 3650 }
	}
}
enchantment_3_0_effect = { # Dominate to Surrender
	if = {
		limit = { NOT = { has_estate_privilege = estate_mages_organization_onyxguard } }
		increase_witch_king_points_large = { level = enchantment_level_3 }
	}
	else = { custom_tooltip = onyxguard_no_infamy_siege }
	PREV = {
		hidden_effect = {
			save_event_target_as = dominated_province
			controller = { country_event = { id = magic_spell.405 days = 3 } }
		}
		add_core = PREV
		custom_tooltip = enchantment_3_0_spell_effect_tt

		#We use a modifier instead of change_controller so we can still trigger lich-hunts etc.
		hidden_effect = { add_province_modifier = { name = enchantment_3_0_siege_mod duration = 4 } }
		add_province_modifier = { name = enchantment_3_0_local_mod duration = 1825 }
	}
	hidden_effect = {
		add_or_extend_country_modifier = { name = enchantment_3_0_tracker_mod duration = 1825 hidden = yes }
		country_event = { id = magic_spell.400 days = 1825 random = 3650 }
	}
}

#################
### EVOCATION ###
#################

evocation_0_0_effect = { # Fireball
	if = {
		limit = { NOT = { has_estate_privilege = estate_mages_organization_onyxguard } }
		increase_witch_king_points_small = yes
	}
	else = { custom_tooltip = onyxguard_no_infamy_siege }
	PREV = {
		add_devastation = 20
		if = {
			limit = {
				PREV = {
					OR = {
						has_ruler_flag = rakshasa_patron
						has_ruler_flag = manifestation_of_surael_patron
					}
				}
			}
			custom_tooltip = evocation_0_0_buffed_spell_effect_tt
			custom_tooltip = magic_booster_by_patron_tt
			hidden_effect = { change_siege = 3 }
		}
		else = {
			custom_tooltip = evocation_0_0_spell_effect_tt
			hidden_effect = { change_siege = 2 }
		}

		hidden_effect = {
			save_event_target_as = fireball_province
			controller = { country_event = { id = magic_spell.502 } }
		}
	}
}
evocation_1_0_effect = { # Shock and Awe
	if = {
		limit = { has_ruler_flag = hoko_patron }
		add_country_modifier = { name = patron_green_shock_and_awe duration = 1825 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = { has_ruler_flag = bladedancer_patron }
		add_country_modifier = { name = patron_diranbe_shock_and_awe duration = 1825 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = {
			OR = {
				has_ruler_flag = maiden_patron
				has_ruler_flag = winter_everfrost_patron
			}
		}
		add_country_modifier = { name = patron_ice_shock_and_awe duration = 1825 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else = { add_country_modifier = { name = evocation_1_0_mod duration = 1825 } }
}
evocation_1_1_effect = { # Flaming Munitions
	if = {
		limit = { has_ruler_flag = hoko_patron }
		add_country_modifier = { name = patron_green_munitions duration = 1825 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = { has_ruler_flag = bladedancer_patron }
		add_country_modifier = { name = patron_diranbe_munitions duration = 1825 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = {
			OR = {
				has_ruler_flag = maiden_patron
				has_ruler_flag = winter_everfrost_patron
			}
		}
		add_country_modifier = { name = patron_ice_munitions duration = 1825 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else = {
		add_country_modifier = { name = evocation_1_1_mod duration = 1825 }
		custom_tooltip = evocation_fireball_on_barrage_tt
	}
}
evocation_2_0_effect = { # Meteor Swarm
	if = {
		limit = { NOT = { has_estate_privilege = estate_mages_organization_onyxguard } }
		increase_witch_king_points_large = { level = evocation_level_2_minimum }
	}
	else = { custom_tooltip = onyxguard_no_infamy_siege }
	PREV = {
		remove_fortifications = yes
		add_devastation = 50
		tooltip = { remove_random_development = yes }
		hidden_effect = {
			randnum_effect = {
				max = 6
				case6 = "
					if = { limit = { base_tax = 2 } add_base_tax = -1 }
					else_if = { limit = { base_production = 2 } add_base_production = -1 }
					else_if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
				"
				case5 = "
					if = { limit = { base_tax = 2 } add_base_tax = -1 }
					else_if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
					else_if = { limit = { base_production = 2 } add_base_production = -1 }
				"
				case4 = "
					if = { limit = { base_production = 2 } add_base_production = -1 }
					else_if = { limit = { base_tax = 2 } add_base_tax = -1 }
					else_if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
				"
				case3 = "
					if = { limit = { base_production = 2 } add_base_production = -1 }
					else_if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
					else_if = { limit = { base_tax = 2 } add_base_tax = -1 }
				"
				case2 = "
					if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
					else_if = { limit = { base_tax = 2 } add_base_tax = -1 }
					else_if = { limit = { base_production = 2 } add_base_production = -1 }
				"
				case1 = "
					if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
					else_if = { limit = { base_production = 2 } add_base_production = -1 }
					else_if = { limit = { base_tax = 2 } add_base_tax = -1 }
				"
			}
			save_event_target_as = meteor_province
			controller = { country_event = { id = magic_spell.503 } }
		}
	}
}
evocation_2_1_effect = { # Tearfall
	custom_tooltip = evocation_2_1_spell_effect_tt
	if = {
		limit = { is_month = 11 }
		evocation_2_1_sub_effect = { days = 304 days_2 = 302 }
	}
	if = {
		limit = { is_month = 10 NOT = { is_month = 11 } }
		evocation_2_1_sub_effect = { days = 334 days_2 = 332 }
	}
	if = { #The month of Tearfall
		limit = { is_month = 9 NOT = { is_month = 10 } }
		evocation_2_1_sub_effect = { days = 365 days_2 = 363 }
	}
	if = {
		limit = { is_month = 8 NOT = { is_month = 9 } }
		evocation_2_1_sub_effect = { days = 30 days_2 = 28 }
	}
	if = {
		limit = { is_month = 7 NOT = { is_month = 8 } }
		evocation_2_1_sub_effect = { days = 61 days_2 = 59 }
	}
	if = {
		limit = { is_month = 6 NOT = { is_month = 7 } }
		evocation_2_1_sub_effect = { days = 92 days_2 = 90 }
	}
	if = {
		limit = { is_month = 5 NOT = { is_month = 6 } }
		evocation_2_1_sub_effect = { days = 122 days_2 = 120 }
	}
	if = {
		limit = { is_month = 4 NOT = { is_month = 5 } }
		evocation_2_1_sub_effect = { days = 153 days_2 = 151 }
	}
	if = {
		limit = { is_month = 3 NOT = { is_month = 4 } }
		evocation_2_1_sub_effect = { days = 183 days_2 = 181 }
	}
	if = { limit = { is_month = 2 NOT = { is_month = 3 } }
		evocation_2_1_sub_effect = { days = 214 days_2 = 212 }
	}
	if = { limit = { is_month = 1 NOT = { is_month = 2 } }
		evocation_2_1_sub_effect = { days = 242 days_2 = 240 }
	}
	if = { limit = { NOT = { is_month = 1 } }
		evocation_2_1_sub_effect = { days = 273 days_2 = 271 }
	}
	custom_tooltip = EVENT_INSIGHT_INTRO
	custom_tooltip = evocation_2_1_spell_effect_2_tt
}
evocation_2_1_sub_effect = { # Tearfall sub-effect
	tooltip = { country_event = { id = magic_spell.500 days = $days$ } }
	add_country_modifier = { name = evocation_2_1_cooldown_mod duration = $days$ hidden = yes }
	hidden_effect = { country_event = { id = magic_spell.501 days = $days_2$ } }
	#Hidden event that fires two days before, to account for the one-day delay on PTMs and the expiring modifier
}
evocation_3_0_effect = { # Elemental Fury
	if = {
		limit = { has_ruler_flag = hoko_patron }
		add_country_modifier = { name = patron_green_elemental_fury duration = 3650 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = { has_ruler_flag = bladedancer_patron }
		add_country_modifier = { name = patron_diranbe_elemental_fury duration = 3650 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = {
			OR = {
				has_ruler_flag = maiden_patron
				has_ruler_flag = winter_everfrost_patron
			}
		}
		add_country_modifier = { name = patron_ice_elemental_fury duration = 3650 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else = {
		add_country_modifier = { name = evocation_3_0_mod duration = 3650 }
		custom_tooltip = evocation_fireball_on_barrage_tt
	}
}

################
### ILLUSION ###
################

illusion_0_0_effect = { # Invisibility
	add_country_modifier = { name = illusion_0_0_mod duration = 3650 }
}
illusion_1_0_effect = { #Fear and Loathing
	custom_tooltip = spell_sabotage_effect_tt
	if = {
		limit = { has_country_flag = witch_king_armies }
		custom_tooltip = illusion_1_0_wk_effect
		hidden_effect = {
			every_war_enemy_country = {
				limit = { capital_scope = { controlled_by = PREV has_siege = no } }
				country_event = { id = magic_spell.601 }
				capital_scope = { magical_abomination = 1 }
			}
			every_rival_country = {
				limit = { NOT = { war_with = ROOT } capital_scope = { controlled_by = PREV has_siege = no } }
				country_event = { id = magic_spell.601 }
				capital_scope = { magical_abomination = 1 }
			}
		}
	}
	if = {
		limit = { NOT = { has_country_flag = witch_king_armies } }
		custom_tooltip = illusion_1_0_effect
		hidden_effect = {
			every_war_enemy_country = {
				limit = { capital_scope = { controlled_by = PREV has_siege = no } }
				country_event = { id = magic_spell.601 }
				capital_scope = { anti_tax_rebels = 1 }
			}
			every_rival_country = {
				limit = { NOT = { war_with = ROOT } capital_scope = { controlled_by = PREV has_siege = no } }
				country_event = { id = magic_spell.601 }
				capital_scope = { anti_tax_rebels = 1 }
			}
		}
	}
}
illusion_1_1_effect = { # Bread and Circuses
	decrease_estate_witch_king_points = { size = medium }
	if = {
		limit = {
			OR = {
				has_ruler_flag = rakshasa_patron
				has_ruler_flag = unthroned_patron
			}
		}
		add_prestige = 20
		custom_tooltip = magic_booster_by_patron_tt
	}
	else = { add_prestige = 10 }
	
	if = {
		limit = { has_any_active_estate_agenda = yes }
		custom_tooltip = illusion_1_1_yes_active_agenda
	}
	else = { custom_tooltip = illusion_1_1_no_active_agenda }

	hidden_effect = {
		if = {
			limit = { NOT = { has_any_active_estate_agenda = yes } }
			country_event = { id = estate_privileges_and_agendas_events.3 }
			add_estate_loyalty = { estate = all loyalty = 5 }
		}
		else = { auto_complete_estate_agenda = { estate = all } }
	}
}
illusion_2_0_effect = { # Assimilation Program
	add_country_modifier = { name = illusion_2_0_mod duration = 7300 }
}
illusion_2_1_effect = { # Shadows in the Night
	custom_tooltip = spell_sabotage_effect_tt
	tooltip = { add_country_modifier = { name = illusion_2_1_mod duration = 1825 } }
	hidden_effect = {
		every_war_enemy_country = { country_event = { id = magic_spell.600 } add_country_modifier = { name = illusion_2_1_mod duration = 1825 } }
		every_rival_country = { country_event = { id = magic_spell.600 } add_country_modifier = { name = illusion_2_1_mod duration = 1825 } }
	}
}
illusion_3_0_effect = { # Lead the Crowds
	decrease_estate_witch_king_points = { size = large }
	custom_tooltip = illusion_3_0_effect
	hidden_effect = { every_owned_province = { add_nationalism = -10 } }
	add_country_modifier = { name = illusion_3_0_mod duration = 3650 }
}

##################
### NECROMANCY ###
##################

necromancy_0_0_effect = { # False Life
	add_country_modifier = { name = necromancy_0_0_mod duration = 1825 }
	if = {
		limit = { has_cast_undead_army = yes }
		custom_tooltip = necromancy_0_0_spell_effect_2_tt
		capital_scope = {
			infantry = ROOT
			infantry = ROOT
			infantry = ROOT
			infantry = ROOT
			infantry = ROOT
		}
	}
	else = {
		custom_tooltip = necromancy_0_0_spell_effect_1_tt
		tooltip = {
			capital_scope = {
				undead_1_zombie_horde = ROOT
				undead_1_zombie_horde = ROOT
				undead_1_zombie_horde = ROOT
				undead_1_zombie_horde = ROOT
				undead_1_zombie_horde = ROOT
			}
		}
	}
}

necromancy_1_0_effect = { # Steal Vitality
	increase_witch_king_points_medium = { level = necromancy_level_1_minimum }
	if = {
		limit = { has_ruler_flag = winter_everfrost_patron }
		capital_scope = {
			tooltip = { remove_random_development = yes }
			custom_tooltip = magic_booster_by_patron_tt
			hidden_effect = {
				randnum_effect = {
					max = 6
					case6 = "
						if = { limit = { base_tax = 2 } add_base_tax = -1 }
						else_if = { limit = { base_production = 2 } add_base_production = -1 }
						else_if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
					"
					case5 = "
						if = { limit = { base_tax = 2 } add_base_tax = -1 }
						else_if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
						else_if = { limit = { base_production = 2 } add_base_production = -1 }
					"
					case4 = "
						if = { limit = { base_production = 2 } add_base_production = -1 }
						else_if = { limit = { base_tax = 2 } add_base_tax = -1 }
						else_if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
					"
					case3 = "
						if = { limit = { base_production = 2 } add_base_production = -1 }
						else_if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
						else_if = { limit = { base_tax = 2 } add_base_tax = -1 }
					"
					case2 = "
						if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
						else_if = { limit = { base_tax = 2 } add_base_tax = -1 }
						else_if = { limit = { base_production = 2 } add_base_production = -1 }
					"
					case1 = "
						if = { limit = { base_manpower = 2 } add_base_manpower = -1 }
						else_if = { limit = { base_production = 2 } add_base_production = -1 }
						else_if = { limit = { base_tax = 2 } add_base_tax = -1 }
					"
				}
			}
		}
	}
	else = {
		capital_scope = {
			add_base_tax = -1
			add_base_production = -1
			add_base_manpower = -1
		}
	}
	add_country_modifier = { name = necromancy_1_0_mod duration = 3650 }
}
necromancy_1_1_effect = { # Contagion
	increase_witch_king_points_medium = { level = necromancy_level_1_minimum }
	PREV = {
		add_devastation = 20
		add_province_modifier = { name = necromancy_1_1_local_mod duration = 1825 }
	}
	hidden_effect = {
		save_event_target_as = contagion_province
		every_war_enemy_country = {
			limit = { event_target:contagion_province = { sieged_by = PREV } }
			country_event = { id = magic_spell.710 } #Nofication
		}
	}
}
necromancy_2_0_effect = { # Speak With Dead

	add_ruler_modifier = { name = necromancy_2_0_mod duration = 3650 }
	tooltip = { add_random_ruler_skill = yes }
	
	hidden_effect = {
		randnum_effect = {
			max = 6
			case6 = "
				if = { limit = { NOT = { adm = 6 } } change_adm = 1 }
				else_if = { limit = { NOT = { dip = 6 } } change_dip = 1 }
				else = { change_mil = 1 }
			"
			case5 = "
				if = { limit = { NOT = { adm = 6 } } change_adm = 1 }
				else_if = { limit = { NOT = { mil = 6 } } change_mil = 1 }
				else = { change_dip = 1 }
			"
			case4 = "
				if = { limit = { NOT = { dip = 6 } } change_dip = 1 }
				else_if = { limit = { NOT = { mil = 6 } } change_mil = 1 }
				else = { change_adm = 1 }
			"
			case3 = "
				if = { limit = { NOT = { dip = 6 } } change_dip = 1 }
				else_if = { limit = { NOT = { adm = 6 } } change_adm = 1 }
				else = { change_mil = 1 }
			"
			case2 = "
				if = { limit = { NOT = { mil = 6 } } change_mil = 1 }
				else_if = { limit = { NOT = { adm = 6 } } change_adm = 1 }
				else = { change_dip = 1 }
			"
			case1 = "
				if = { limit = { NOT = { mil = 6 } } change_mil = 1 }
				else_if = { limit = { NOT = { dip = 6 } } change_dip = 1 }
				else = { change_adm = 1 }
			"
		}
	}
}
necromancy_2_1_effect = { # Ghoulish Grandeur
	add_country_modifier = { name = necromancy_2_1_mod duration = 3650 }
}
necromancy_3_0_effect = { # Undead Army
	if = {
		limit = { is_ruler_necromancy_level_3 = yes }
		custom_tooltip = necromancy_3_0_spell_effect_tt
	}
	else = { custom_tooltip = necromancy_3_0_spell_effect_2_tt }
	hidden_effect = {
		increase_witch_king_points_large = { level = necromancy_level_3 }
		increase_witch_king_points_large = { level = necromancy_level_3 }
		increase_witch_king_points_large = { level = necromancy_level_3 }
		increase_witch_king_points_large = { level = necromancy_level_3 }
	}
	clear_racial_military = yes
	change_unit_type = tech_undead
	custom_tooltip = GetRacialMilUndead
	add_country_modifier = { name = undead_military duration = -1 hidden = yes }
	custom_tooltip = undead_military_hint

	update_mana_regen_vars = yes
}

#####################
### TRANSMUTATION ###
#####################

transmutation_0_0_effect = { # Longstrider
	add_country_modifier = { name = transmutation_0_0_mod duration = 180 }
}
transmutation_1_0_effect = { # Plant Growth
	custom_tooltip = transmutation_1_0_spell_effect_tt
	if = {
		limit = {
			OR = {
				has_ruler_flag = yaksha_patron
				has_ruler_flag = nang_patron
				has_ruler_flag = manifestation_of_surael_patron
			}
		}
		transmutation_1_0_sub_effect = { days = 3650 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else_if = {
		limit = { has_ruler_flag = spring_old_patron }
		transmutation_1_0_sub_effect = { days = 2555 }
		custom_tooltip = magic_booster_by_patron_tt
	}
	else = { transmutation_1_0_sub_effect = { days = 1825 } }
	if = {
		limit = { has_estate_privilege = estate_mages_fifth_family }
		custom_tooltip = toarnaire_fifth_tt
		hidden_effect = {
			every_owned_province = {
				limit = { has_building = mage_tower trade_goods = wine }
				add_province_modifier = {
					name = toarnaire_wine
					duration = 3650
				}
			}
		}
	}
}
transmutation_1_0_sub_effect = { #Plant Growth - sub-effect
	tooltip = { 4160 = { add_province_modifier = { name = transmutation_1_0_local_mod duration = $days$ } } }
	hidden_effect = {
		if = {
			limit = { 
				has_great_project = {
				type = grave_forest_of_ilvandet
				tier = 2
				}
			}
			every_owned_province = {
				limit = { province_with_arable_goods = yes }
				add_province_modifier = { name = transmutation_1_0_local_mod_upgraded duration = $days$ }
			}
		}
		else = {
			every_owned_province = {
				limit = { province_with_arable_goods = yes }
				add_province_modifier = { name = transmutation_1_0_local_mod duration = $days$ }
			}
		}
		add_country_modifier = { name = transmutation_1_0_cooldown_mod duration = $days$ hidden = yes }
	}
}
transmutation_1_1_effect = { # Mass Enlarge
	PREV = { add_province_modifier = { name = transmutation_1_1_local_mod duration = 730 } }
}
transmutation_2_0_effect = { # Transmute to Gold
	add_inflation = 1
	add_owned_provinces_development_ducats = {
		trigger = {
			OR = {
				trade_goods = copper
				trade_goods = iron
				trade_goods = mithril
				trade_goods = gold
			}
		}
		multiplier = 4
		age_multiplier = 0.5
		custom_tooltip = transmutation_2_0_spell_effect_1_tt
	}
	custom_tooltip = transmutation_2_0_spell_effect_2_tt
	hidden_effect = {
		set_variable = { max_var = 0 }
		if = {
			limit = { copper = 1 }
			every_owned_province = {
				limit = { trade_goods = copper }
				PREV = { change_variable = { max_var = 1 } }
			}
			randnum_effect = { max_var = max_var }
			every_owned_province = {
				limit = { trade_goods = copper }
				if = {
					limit = { PREV = { is_variable_equal = { which = randnum value = 1 } } }
					province_event = { id = magic_spell.806 }
				}
				PREV = { subtract_variable = { randnum = 1 } }
			}
		}
		if = {
			limit = {
				NOT = { copper = 1 }
				iron = 1
			}
			every_owned_province = {
				limit = { trade_goods = iron }
				PREV = { change_variable = { max_var = 1 } }
			}
			randnum_effect = { max_var = max_var }
			every_owned_province = {
				limit = { trade_goods = iron }
				if = {
					limit = { PREV = { is_variable_equal = { which = randnum value = 1 } } }
					province_event = { id = magic_spell.806 }
				}
				PREV = { subtract_variable = { randnum = 1 } }
			}
		}
		if = {
			limit = {
				NOT = {
					copper = 1
					iron = 1
				}
				mithril = 1
			}
			every_owned_province = {
				limit = { trade_goods = mithril }
				PREV = { change_variable = { max_var = 1 } }
			}
			randnum_effect = { max_var = max_var }
			every_owned_province = {
				limit = { trade_goods = mithril }
				if = {
					limit = { PREV = { is_variable_equal = { which = randnum value = 1 } } }
					province_event = { id = magic_spell.806 }
				}
				PREV = { subtract_variable = { randnum = 1 } }
			}
		}
	}
}
transmutation_2_1_effect = { # Reshape Terrain
	if = {
		limit = { has_country_flag = better_reshape_terrain }
		add_country_modifier = { name = transmutation_2_1_buffed_mod duration = 3650 }
		custom_tooltip = magic_booster_by_eilisin_tt
	}
	else = { add_country_modifier = { name = transmutation_2_1_mod duration = 3650 } }
}
transmutation_3_0_effect = { # Rite of Conception
	if = {
		limit = {
			OR = {
				has_country_flag = tughayasa_reward
				has_country_flag = tughayasa_reward_primary
			}
		}
		if = {
			limit = { has_government_attribute = heir }
			tooltip = {
				random_list = {
					1 = { country_event = { id = magic_spell.800 days = 240 random = 60 } }
					1 = { country_event = { id = magic_spell.801 days = 240 random = 60 } }
				}
			}
			hidden_effect = {
				add_country_modifier = { name = transmutation_3_0_cooldown_mod duration = 301 }
				capital_scope = { add_province_triggered_modifier = rite_of_conception_randomization_ptm }
			}
		}
		if = {
			limit = { NOT = { has_government_attribute = heir } }
			country_event = { id = magic_spell.803 }
		}
		custom_tooltip = tughayasa_empowered_tt
	}
	if = {
		limit = {
			NOT = {
				has_country_flag = tughayasa_reward
				has_country_flag = tughayasa_reward_primary
			}
		}
		tooltip = {
			random_list = {
				33 = { country_event = { id = magic_spell.800 days = 240 random = 60 } }
				33 = { country_event = { id = magic_spell.801 days = 240 random = 60 } }
				33 = { country_event = { id = magic_spell.802 days = 240 random = 60 } }
				1 = { country_event = { id = magic_spell.804 days = 240 random = 60 } }
			}
		}
		hidden_effect = { 
			add_country_modifier = { name = transmutation_3_0_cooldown_mod duration = 301 hidden = yes }
			capital_scope = { add_province_triggered_modifier = rite_of_conception_randomization_ptm }
		}
	}
}